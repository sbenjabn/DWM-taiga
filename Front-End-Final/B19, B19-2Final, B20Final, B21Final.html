<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .muted-small { font-size:0.9rem; color:#6c757d; }
    .card-title { font-weight:600; }
    .metrics { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    .metric { background:#f8f9fa; padding:10px 12px; border-radius:8px; min-width:140px; }
    .table-wrap { max-height:420px; overflow:auto; }
    .actions { display:flex; gap:8px; align-items:center; }
    .filters-row { display:flex; gap:8px; align-items:end; flex-wrap:wrap; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Generar reporte</h4>
      <div class="muted-small">Seleccione rango, tipo y filtros</div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label small mb-1">Desde</label>
            <input id="dateFrom" type="date" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label small mb-1">Hasta</label>
            <input id="dateTo" type="date" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label small mb-1">Tipo de reporte</label>
            <select id="reportType" class="form-select" onchange="onReportTypeChange()">
              <option value="ventas">Ventas</option>
              <option value="pedidos">Pedidos</option>
            </select>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-primary" onclick="generarReporte()">Generar reporte</button>
          </div>
        </div>

        <div class="mt-3 muted-small">Para un solo día, deje la misma fecha en Desde y Hasta</div>

        <hr class="my-3" />

        <div class="filters-row">
          <div>
            <label class="form-label small mb-1">Filtrar por Producto</label>
            <select id="filterProducto" class="form-select">
              <option value="">-- Todos los productos --</option>
            </select>
          </div>
          <div>
            <label class="form-label small mb-1">Filtrar por Vendedor</label>
            <select id="filterVendedor" class="form-select">
              <option value="">-- Todos los vendedores --</option>
            </select>
          </div>
          <div class="align-self-end">
            <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">Limpiar filtros</button>
          </div>
        </div>

      </div>
    </div>

    <div id="resultSection" class="d-none">
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <div class="card-title" id="reportTitle">Reporte</div>
            <div class="actions">
              <button class="btn btn-outline-success" onclick="exportCSV()">Exportar CSV</button>
              <button class="btn btn-primary" onclick="imprimirReporte()">Exportar PDF</button>
            </div>
          </div>

          <div class="metrics" id="metricsArea"></div>

          <div class="table-wrap">
            <table class="table table-sm table-striped">
              <thead>
                <tr id="tableHead"></tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>

          <div id="reportNotes" class="muted-small mt-2"></div>
        </div>
      </div>
    </div>

    <div id="msgArea"></div>
  </div>

<script>

const SAMPLE_KEY = "bb_report_samples_v2";

function seedSamples() {
  try {
    if (localStorage.getItem(SAMPLE_KEY)) return;
    const samples = [];

    const menu = [
      { nombre: "Hamburguesa queso", precio: 5990 },
      { nombre: "Papas medianas", precio: 1990 },
      { nombre: "Coca Cola", precio: 1200 },
      { nombre: "Helado de vainilla San Francisco", precio: 2500 }
    ];
    const vendedores = ["Laura Pérez", "Marcos Díaz", "Ana Gómez"];

    for (let d = 1; d <= 30; d++) {
      const day = d.toString().padStart(2,'0');
      const date = `2023-08-${day}`;
      const count = Math.floor(Math.random()*5) + 3;
      for (let i=0;i<count;i++) {
        const pick = menu[Math.floor(Math.random()*menu.length)];
        const vendedor = vendedores[Math.floor(Math.random()*vendedores.length)];
        const cliente = `Cliente ${Math.floor(Math.random()*90)+10}`;
        samples.push({
          date,
          type: 'venta',
          items: [{ nombre: pick.nombre, qty: 1, precio: pick.precio }],
          total: pick.precio,
          status: 'entregado',
          prepTimeMin: 10 + Math.floor(Math.random()*8),
          dispatchTimeMin: 5 + Math.floor(Math.random()*6),
          vendedor,
          cliente
        });
      }
    }

    const specificDates = ["2023-08-05","2023-08-12","2023-08-20","2023-09-10"];
    specificDates.forEach((dt, idx) => {
      samples.push({
        date: dt,
        type: 'venta',
        items: [{ nombre: "Helado de vainilla San Francisco", qty: 2, precio: 2500 }],
        total: 2 * 2500,
        status: 'entregado',
        prepTimeMin: 5 + idx,
        dispatchTimeMin: 3 + idx,
        vendedor: idx % 2 === 0 ? "Laura Pérez" : "Marcos Díaz",
        cliente: `Cliente Esp ${idx+1}`
      });
    });

    const dateSep = "2023-09-10";
    const statuses = ['entregado','entregado','cancelado','entregado'];
    for (let i=0;i<12;i++) {
      const items = [{ nombre: (i%2===0 ? "Hamburguesa queso" : "Papas medianas"), qty:1, precio: i%2===0?5990:1990 }];
      samples.push({
        date: dateSep,
        type: 'pedido',
        items,
        total: items.reduce((s,it)=> s + it.precio*it.qty,0),
        status: statuses[i%statuses.length],
        prepTimeMin: 8 + Math.floor(Math.random()*10),
        dispatchTimeMin: 4 + Math.floor(Math.random()*6),
        vendedor: vendedores[i % vendedores.length],
        cliente: `Cliente ${100 + i}`
      });
    }

    localStorage.setItem(SAMPLE_KEY, JSON.stringify(samples));
  } catch(e) { console.error(e); }
}

function loadSamples() {
  try { return JSON.parse(localStorage.getItem(SAMPLE_KEY) || "[]"); } catch { return []; }
}

function poblarFiltros() {
  const samples = loadSamples();
  const prodSet = new Set();
  const vendSet = new Set();
  samples.forEach(s => {
    (s.items || []).forEach(it => prodSet.add(it.nombre));
    if (s.vendedor) vendSet.add(s.vendedor);
  });
  const prodSel = document.getElementById('filterProducto');
  const vendSel = document.getElementById('filterVendedor');
  prodSel.innerHTML = '<option value="">-- Todos los productos --</option>';
  vendSel.innerHTML = '<option value="">-- Todos los vendedores --</option>';
  Array.from(prodSet).sort().forEach(p => {
    const opt = document.createElement('option'); opt.value = p; opt.textContent = p; prodSel.appendChild(opt);
  });
  Array.from(vendSet).sort().forEach(v => {
    const opt = document.createElement('option'); opt.value = v; opt.textContent = v; vendSel.appendChild(opt);
  });
}

function formatCurrency(n){ return `$ ${Number(n||0).toLocaleString()}`; }
function showMessage(text, type='info'){ const area = document.getElementById('msgArea'); area.innerHTML = `<div class="alert alert-${type}">${text}</div>`; setTimeout(()=> area.innerHTML = '', 3500); }
function parseDateInput(v){ return v ? v : null; }
function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function limpiarFiltros() {
  document.getElementById('filterProducto').value = '';
  document.getElementById('filterVendedor').value = '';
  showMessage('Filtros limpiados', 'info');
}

function onReportTypeChange() {
}

function generarReporte() {
  const from = parseDateInput(document.getElementById('dateFrom').value);
  const to = parseDateInput(document.getElementById('dateTo').value);
  const type = document.getElementById('reportType').value;
  const filterProducto = (document.getElementById('filterProducto').value || '').trim();
  const filterVendedor = (document.getElementById('filterVendedor').value || '').trim();

  if (!from || !to) return showMessage('Selecciona desde y hasta', 'warning');
  if (from > to) return showMessage('El rango es inválido (desde debe ser <= hasta)', 'warning');

  let samples = loadSamples().filter(s => s.date >= from && s.date <= to && ((type === 'ventas' && s.type === 'venta') || (type === 'pedidos' && s.type === 'pedido')) );

  if (filterProducto) {
    samples = samples.filter(s => (s.items || []).some(it => it.nombre === filterProducto));
  }

  if (filterVendedor) {
    samples = samples.filter(s => (s.vendedor || '') === filterVendedor);
  }

  const titleParts = [];
  titleParts.push(type === 'ventas' ? 'Reporte de Ventas' : 'Reporte de Pedidos');
  if (filterProducto) titleParts.push(`Producto: ${filterProducto}`);
  if (filterVendedor) titleParts.push(`Vendedor: ${filterVendedor}`);
  titleParts.push(`${from} → ${to}`);
  document.getElementById('reportTitle').textContent = titleParts.join(' · ');

  const metricsArea = document.getElementById('metricsArea');
  metricsArea.innerHTML = '';

  if (type === 'ventas') {
    const totalVentas = samples.reduce((s,it) => s + (it.total || 0), 0);
    const totalCount = samples.length;
    const ticketProm = totalCount ? Math.round(totalVentas / totalCount) : 0;

    if (filterProducto && !filterVendedor) {
      let cantidadTotal = 0;
      const byVendedor = {};
      samples.forEach(s => {
        s.items.forEach(it => {
          if (it.nombre === filterProducto) {
            cantidadTotal += (it.qty || 1);
            byVendedor[s.vendedor || '—'] = (byVendedor[s.vendedor || '—'] || 0) + ((it.qty || 1) * (it.precio || 0));
          }
        });
      });
      metricsArea.appendChild(createMetric('Cantidad vendida', cantidadTotal));
      metricsArea.appendChild(createMetric('Total facturado', formatCurrency(samples.reduce((sum,s)=>{
        return sum + s.items.filter(it=>it.nombre===filterProducto).reduce((ss,it)=> ss + (it.qty||1)*(it.precio||0),0);
      },0))));
      const sellers = Object.entries(byVendedor).map(e=> `${e[0]}: ${formatCurrency(e[1])}`).join(', ') || '—';
      metricsArea.appendChild(createMetric('Facturado por vendedor', sellers));
      // Table: fecha, cantidad vendida (por registro), total facturado, vendedor
      const rows = [];
      samples.forEach(s => {
        const matches = s.items.filter(it=>it.nombre===filterProducto);
        matches.forEach(m => rows.push({
          Fecha: s.date,
          Cantidad: m.qty || 1,
          'Total facturado': formatCurrency((m.qty||1)*(m.precio||0)),
          Vendedor: s.vendedor || '—'
        }));
      });
      fillTable(['Fecha','Cantidad','Total facturado','Vendedor'], rows);
      document.getElementById('reportNotes').textContent = `Ventas del producto "${filterProducto}" en el periodo. Registros: ${rows.length}.`;
    } else if (filterVendedor && !filterProducto) {
      const productosMap = {};
      const clientesSet = new Set();
      samples.forEach(s => {
        (s.items||[]).forEach(it => productosMap[it.nombre] = (productosMap[it.nombre]||0) + (it.qty||1));
        if (s.cliente) clientesSet.add(s.cliente);
      });
      const productosStr = Object.entries(productosMap).map(e=> `${e[0]} (${e[1]})`).join(', ') || '—';
      metricsArea.appendChild(createMetric('Total facturado', formatCurrency(totalVentas)));
      metricsArea.appendChild(createMetric('Número de ventas', totalCount));
      metricsArea.appendChild(createMetric('Productos vendidos', productosStr));
      metricsArea.appendChild(createMetric('Clientes atendidos', Array.from(clientesSet).slice(0,5).join(', ') || '—'));

      const rows = samples.map(s => ({
        Fecha: s.date,
        Productos: s.items.map(it=> `${it.nombre} x${it.qty||1}`).join(', '),
        Cliente: s.cliente || '-',
        Total: formatCurrency(s.total || 0)
      }));
      fillTable(['Fecha','Productos','Cliente','Total'], rows);
      document.getElementById('reportNotes').textContent = `Ventas realizadas por ${filterVendedor} en el periodo. Registros: ${samples.length}.`;
    } else if (filterProducto && filterVendedor) {
      const rows = [];
      let cantidadTotal = 0;
      let facturadoTotal = 0;
      samples.forEach(s => {
        s.items.filter(it => it.nombre === filterProducto).forEach(it => {
          rows.push({ Fecha: s.date, Cantidad: it.qty || 1, 'Total facturado': formatCurrency((it.qty||1)*it.precio), Vendedor: s.vendedor || '—' });
          cantidadTotal += it.qty || 1;
          facturadoTotal += (it.qty||1)*it.precio;
        });
      });
      metricsArea.appendChild(createMetric('Cantidad vendida', cantidadTotal));
      metricsArea.appendChild(createMetric('Total facturado', formatCurrency(facturadoTotal)));
      fillTable(['Fecha','Cantidad','Total facturado','Vendedor'], rows);
      document.getElementById('reportNotes').textContent = `Ventas de ${filterProducto} por ${filterVendedor}. Registros: ${rows.length}.`;
    } else {
      const prodMap = {};
      samples.forEach(s => s.items.forEach(it => prodMap[it.nombre] = (prodMap[it.nombre]||0) + (it.qty||1)));
      const top = Object.entries(prodMap).sort((a,b)=> b[1]-a[1]).slice(0,5);
      metricsArea.appendChild(createMetric('Total ventas', formatCurrency(totalVentas)));
      metricsArea.appendChild(createMetric('Número de tickets', totalCount));
      metricsArea.appendChild(createMetric('Ticket promedio', formatCurrency(ticketProm)));
      metricsArea.appendChild(createMetric('Top productos', top.map(t=> `${t[0]} (${t[1]})`).join(', ') || '—'));

      const rows = samples.map(s => ({
        Fecha: s.date,
        Items: s.items.map(it => `${it.nombre} x${it.qty||1}`).join(', '),
        Total: formatCurrency(s.total || 0),
        Vendedor: s.vendedor || '-'
      }));
      fillTable(['Fecha','Items','Total','Vendedor'], rows);
      document.getElementById('reportNotes').textContent = `Periodo: ${from} → ${to}. Tickets: ${totalCount}.`;
    }
  } else {
    const totalPedidos = samples.length;
    const entregados = samples.filter(s=>s.status==='entregado').length;
    const cancelados = samples.filter(s=>s.status==='cancelado').length;
    const avgPrep = totalPedidos ? Math.round(samples.reduce((s,it)=> s + (it.prepTimeMin||0),0) / totalPedidos) : 0;
    const avgDispatch = totalPedidos ? Math.round(samples.reduce((s,it)=> s + (it.dispatchTimeMin||0),0) / totalPedidos) : 0;

    metricsArea.appendChild(createMetric('Pedidos totales', totalPedidos));
    metricsArea.appendChild(createMetric('Entregados', entregados));
    metricsArea.appendChild(createMetric('Cancelados', cancelados));
    metricsArea.appendChild(createMetric('Prep. promedio (min)', `${avgPrep} min`));
    metricsArea.appendChild(createMetric('Despacho promedio (min)', `${avgDispatch} min`));

    const rows = samples.map(s => ({
      Fecha: s.date,
      Items: s.items.map(it => `${it.nombre} x${it.qty||1}`).join(', '),
      Estado: s.status || '-',
      'Prep (min)': s.prepTimeMin || '-',
      'Despacho (min)': s.dispatchTimeMin || '-',
      Vendedor: s.vendedor || '-'
    }));
    fillTable(['Fecha','Items','Estado','Prep (min)','Despacho (min)','Vendedor'], rows);
    document.getElementById('reportNotes').textContent = `Periodo: ${from} → ${to}. Pedidos: ${totalPedidos}.`;
  }

  document.getElementById('resultSection').classList.remove('d-none');
}

function createMetric(title, value) {
  const div = document.createElement('div');
  div.className = 'metric';
  div.innerHTML = `<div class="muted-small">${escapeHtml(title)}</div><div class="fw-semibold">${escapeHtml(String(value))}</div>`;
  return div;
}

function fillTable(headers, rows) {
  const thead = document.getElementById('tableHead');
  const tbody = document.getElementById('tableBody');
  thead.innerHTML = '';
  tbody.innerHTML = '';
  headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    thead.appendChild(th);
  });
  rows.forEach(r => {
    const tr = document.createElement('tr');
    headers.forEach(h => {
      const td = document.createElement('td');
      td.textContent = r[h] ?? '';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function exportCSV() {
  const ths = Array.from(document.querySelectorAll('#tableHead th')).map(t => t.textContent);
  const rows = Array.from(document.querySelectorAll('#tableBody tr')).map(tr => Array.from(tr.children).map(td => td.textContent.replaceAll('"','""')));
  if (ths.length === 0) return showMessage('No hay datos para exportar', 'warning');
  let csv = '"' + ths.join('","') + '"\n';
  rows.forEach(r => csv += '"' + r.join('","') + '"\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const type = document.getElementById('reportType').value;
  const from = document.getElementById('dateFrom').value.replaceAll('-','');
  const to = document.getElementById('dateTo').value.replaceAll('-','');
  a.download = `reporte_${type}_${from}_${to}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function imprimirReporte() {
  window.print();
}

(function init(){
  seedSamples();
  poblarFiltros();
  document.getElementById('dateFrom').value = '2023-08-01';
  document.getElementById('dateTo').value = '2023-08-30';
  document.getElementById('reportType').value = 'ventas';
})();
</script>
</body>
</html>