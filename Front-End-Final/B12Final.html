<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clasificación de Productos - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .muted-small { font-size:0.9rem; color:#6c757d; }
    .cat-title { font-weight:600; margin-bottom:8px; }
    .prod-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee; gap:12px; }
    .prod-meta { color:#6c757d; font-size:0.9rem; }
    .thumb { width:64px; height:64px; object-fit:cover; border-radius:6px; border:1px solid #e9ecef; background:#fff; }
    .no-thumb { width:64px; height:64px; display:inline-flex; align-items:center; justify-content:center; background:#f8f9fa; color:#6c757d; border-radius:6px; border:1px dashed #e9ecef; font-size:0.75rem; }
    .form-file-note { font-size:0.85rem; color:#6c757d; }
  </style>
</head>
<body class="bg-light">
<div class="container mt-4">
  <div class="d-flex align-items-center mb-3 gap-3">
    <input id="buscarProducto" class="form-control form-control-sm" style="min-width:320px" placeholder="Buscar producto..." oninput="renderCategorias()" />
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgregar">+ Agregar</button>
    <div class="ms-auto muted-small">Categorías administrables</div>
  </div>

  <div id="categoriasContainer"></div>

  <div id="msgArea" class="mt-3"></div>
</div>

<!-- Modal: Agregar / Editar producto -->
<div class="modal fade" id="modalAgregar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modalTitle" class="modal-title">Agregar producto</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="formError" class="text-danger d-none mb-2"></div>

        <label class="form-label">Nombre</label>
        <input id="prodNombre" class="form-control mb-2" placeholder="Ej: Hamburguesa queso" />

        <label class="form-label">Descripción</label>
        <input id="prodDescripcion" class="form-control mb-2" placeholder="Breve descripción" />

        <label class="form-label">Precio (CLP)</label>
        <input id="prodPrecio" type="number" min="0" step="1" class="form-control mb-2" placeholder="Ej: 5990" />

        <label class="form-label">Categoría</label>
        <select id="prodCategoria" class="form-select mb-2"></select>

        <label class="form-label">Imagen (opcional)</label>
        <input id="prodImagen" type="file" accept="image/*" class="form-control form-control-sm mb-2" />
        <div class="d-flex align-items-center gap-2 mb-2">
          <img id="previewImagen" class="thumb d-none" alt="Preview" />
          <div class="form-file-note">Formatos: JPG/PNG. Recomendado &lt; 300 KB.</div>
        </div>

        <div class="form-text muted-small">Todos los campos excepto imagen son obligatorios</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="guardarProdBtn" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Cambiar categoría -->
<div class="modal fade" id="modalCambiarCat" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title">Cambiar categoría</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <select id="cambiaCategoriaSelect" class="form-select mb-2"></select>
        <div id="changeError" class="text-danger d-none"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="confirmChangeCatBtn" class="btn btn-primary">Cambiar</button>
      </div>
    </div>
  </div>
</div>

<script>

const PRODUCTS_KEY = "bb_products_v2";
const CATEGORIES_KEY = "bb_categories_v2";

function seedInitial() {
  try {
    const cats = JSON.parse(localStorage.getItem(CATEGORIES_KEY) || "null");
    if (!cats) {
      const initialCats = ["Hamburguesas","Snacks","Bebidas","Postres","Combos"];
      localStorage.setItem(CATEGORIES_KEY, JSON.stringify(initialCats));
    }
    const prods = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || "null");
    if (!prods) {
      const now = Date.now();
      const initialProds = [
        { id:"p-hbq", nombre:"Hamburguesa queso", descripcion:"Con queso cheddar", precio:5990, categoria:"Hamburguesas", creadoEn: now - 1000, imageData: null },
        { id:"p-cc", nombre:"Coca Cola", descripcion:"Bebida 350ml", precio:1200, categoria:"Bebidas", creadoEn: now - 2000, imageData: null }
      ];
      localStorage.setItem(PRODUCTS_KEY, JSON.stringify(initialProds));
    }
  } catch (e) {}
}

function loadCategorias(){ try { return JSON.parse(localStorage.getItem(CATEGORIES_KEY) || "[]"); } catch { return []; } }
function saveCategorias(arr){ localStorage.setItem(CATEGORIES_KEY, JSON.stringify(arr)); }
function loadProductos(){ try { return JSON.parse(localStorage.getItem(PRODUCTS_KEY) || "[]"); } catch { return []; } }
function saveProductos(arr){ localStorage.setItem(PRODUCTS_KEY, JSON.stringify(arr)); }

function showMessage(text, type="success") {
  const area = document.getElementById("msgArea");
  area.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
  setTimeout(()=> area.innerHTML = "", 3000);
}
function showFormError(text){ const e=document.getElementById("formError"); e.textContent=text; e.classList.remove("d-none"); }
function hideFormError(){ const e=document.getElementById("formError"); e.textContent=""; e.classList.add("d-none"); }

function renderCategorias() {
  const q = (document.getElementById("buscarProducto").value || "").trim().toLowerCase();
  const cats = loadCategorias();
  const prods = loadProductos();
  const container = document.getElementById("categoriasContainer");
  container.innerHTML = "";

  if (!cats.length) {
    container.innerHTML = `<div class="muted-small">No hay categorías definidas.</div>`;
    return;
  }

  cats.forEach(cat => {
    const catDiv = document.createElement("div");
    catDiv.className = "mb-4";
    const heading = document.createElement("div");
    heading.className = "cat-title";
    heading.textContent = cat;
    catDiv.appendChild(heading);

    const list = document.createElement("div");
    const filtered = prods.filter(p => p.categoria === cat && (!q || p.nombre.toLowerCase().includes(q) || (p.descripcion||'').toLowerCase().includes(q)));
    if (filtered.length === 0) {
      const none = document.createElement("div");
      none.className = "muted-small mb-2";
      none.textContent = "No hay productos en esta categoría.";
      list.appendChild(none);
    } else {
      filtered.forEach(p => {
        const row = document.createElement("div");
        row.className = "prod-row";
        row.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;">
            ${p.imageData ? `<img src="${p.imageData}" class="thumb" alt="${escapeHtml(p.nombre)}" />` : `<div class="no-thumb">SIN IMG</div>`}
            <div>
              <div class="fw-semibold">${escapeHtml(p.nombre)}</div>
              <div class="prod-meta">${escapeHtml(p.descripcion)} · $ ${Number(p.precio).toLocaleString()}</div>
            </div>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-outline-secondary" onclick="abrirCambiarCategoria('${p.id}')">Cambiar</button>
            <button class="btn btn-sm btn-outline-danger" onclick="eliminarProducto('${p.id}')">Eliminar</button>
          </div>`;
        list.appendChild(row);
      });
    }

    catDiv.appendChild(list);
    container.appendChild(catDiv);
  });
}

function fillCategoriaSelect() {
  const sel = document.getElementById("prodCategoria");
  sel.innerHTML = "";
  loadCategorias().forEach(c => {
    const opt = document.createElement("option"); opt.value = c; opt.textContent = c; sel.appendChild(opt);
  });
}

document.getElementById("prodImagen").addEventListener('change', function (ev) {
  const file = ev.target.files[0];
  const preview = document.getElementById("previewImagen");
  if (!file) {
    preview.src = "";
    preview.classList.add("d-none");
    return;
  }
  if (!file.type.startsWith("image/")) {
    showFormError("El archivo debe ser una imagen");
    ev.target.value = "";
    preview.classList.add("d-none");
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    preview.src = e.target.result;
    preview.classList.remove("d-none");
  };
  reader.readAsDataURL(file);
});

document.getElementById("guardarProdBtn").addEventListener('click', function(){
  const nombre = (document.getElementById("prodNombre").value || "").trim();
  const descripcion = (document.getElementById("prodDescripcion").value || "").trim();
  const precioRaw = document.getElementById("prodPrecio").value;
  const precio = precioRaw === "" ? null : Number(precioRaw);
  const categoria = (document.getElementById("prodCategoria").value || "").trim();

  if (!nombre) return showFormError("El campo nombre es obligatorio");
  if (!descripcion) return showFormError("El campo descripción es obligatorio");
  if (precio === null || isNaN(precio)) return showFormError("El campo precio es obligatorio");
  if (!categoria) return showFormError("Selecciona una categoría");

  const productos = loadProductos();

  const fileInput = document.getElementById("prodImagen");
  const file = fileInput.files[0];

  const saveWithImage = (imageData) => {
    if (window._editingProductId) {
      const idx = productos.findIndex(p => p.id === window._editingProductId);
      if (idx !== -1) {
        productos[idx].nombre = nombre;
        productos[idx].descripcion = descripcion;
        productos[idx].precio = precio;
        productos[idx].categoria = categoria;
        if (typeof imageData !== "undefined") productos[idx].imageData = imageData;
        productos[idx].modificadoEn = Date.now();
        saveProductos(productos);
        hideFormError();
        bootstrap.Modal.getInstance(document.getElementById("modalAgregar")).hide();
        window._editingProductId = null;
        showMessage("Producto actualizado exitosamente", "success");
        renderCategorias();
        return;
      }
    }

    const nuevo = { id: "p-" + Math.random().toString(36).slice(2,9), nombre, descripcion, precio, categoria, creadoEn: Date.now(), imageData: imageData || null };
    productos.unshift(nuevo);
    saveProductos(productos);
    hideFormError();
    bootstrap.Modal.getInstance(document.getElementById("modalAgregar")).hide();
    showMessage("Producto creado exitosamente", "success");
    renderCategorias();
    document.getElementById("prodNombre").value = "";
    document.getElementById("prodDescripcion").value = "";
    document.getElementById("prodPrecio").value = "";
    document.getElementById("prodCategoria").value = "";
    document.getElementById("prodImagen").value = "";
    document.getElementById("previewImagen").src = "";
    document.getElementById("previewImagen").classList.add("d-none");
  };

  if (file) {
    const maxBytes = 300 * 1024;
    if (file.size > maxBytes) {
      return showFormError("Imagen demasiado grande. Use una imagen < 300 KB");
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      const dataUrl = e.target.result;
      saveWithImage(dataUrl);
    };
    reader.onerror = function() { showFormError("No se pudo leer la imagen"); };
    reader.readAsDataURL(file);
  } else {
    saveWithImage(undefined);
  }
});

let _changeProductId = null;
function abrirCambiarCategoria(productId) {
  _changeProductId = productId;
  const sel = document.getElementById("cambiaCategoriaSelect");
  sel.innerHTML = "";
  loadCategorias().forEach(c => { const opt = document.createElement("option"); opt.value=c; opt.textContent=c; sel.appendChild(opt); });
  const prod = loadProductos().find(p => p.id === productId);
  if (prod) sel.value = prod.categoria || sel.options[0]?.value;
  document.getElementById("changeError").classList.add("d-none");
  const modal = new bootstrap.Modal(document.getElementById("modalCambiarCat"));
  modal.show();
}

document.getElementById("confirmChangeCatBtn").addEventListener('click', function(){
  const newCat = document.getElementById("cambiaCategoriaSelect").value;
  if (!_changeProductId) return;
  if (!newCat) { document.getElementById("changeError").textContent = "Selecciona una categoría"; document.getElementById("changeError").classList.remove("d-none"); return; }
  const productos = loadProductos();
  const idx = productos.findIndex(p => p.id === _changeProductId);
  if (idx === -1) { document.getElementById("changeError").textContent = "Producto no encontrado"; document.getElementById("changeError").classList.remove("d-none"); return; }
  productos[idx].categoria = newCat;
  productos[idx].modificadoEn = Date.now();
  saveProductos(productos);
  bootstrap.Modal.getInstance(document.getElementById("modalCambiarCat")).hide();
  showMessage("Categoría actualizada correctamente", "success");
  renderCategorias();
  _changeProductId = null;
});

function editarProducto(id) {
  const productos = loadProductos();
  const p = productos.find(x => x.id === id);
  if (!p) return alert("Producto no encontrado");
  window._editingProductId = id;
  document.getElementById("modalTitle").textContent = "Editar producto";
  document.getElementById("prodNombre").value = p.nombre || "";
  document.getElementById("prodDescripcion").value = p.descripcion || "";
  document.getElementById("prodPrecio").value = p.precio != null ? p.precio : "";
  document.getElementById("prodCategoria").value = p.categoria || "";
  document.getElementById("prodImagen").value = "";
  const preview = document.getElementById("previewImagen");
  if (p.imageData) {
    preview.src = p.imageData;
    preview.classList.remove("d-none");
  } else {
    preview.src = "";
    preview.classList.add("d-none");
  }
  hideFormError();
  fillCategoriaSelect();
  const modal = new bootstrap.Modal(document.getElementById("modalAgregar"));
  modal.show();
}

function eliminarProducto(id) {
  if (!confirm("Eliminar producto?")) return;
  const prods = loadProductos().filter(p => p.id !== id);
  saveProductos(prods);
  showMessage("Producto eliminado", "warning");
  renderCategorias();
}

function escapeHtml(s) { return (s||"").toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

(function init(){
  seedInitial();
  fillCategoriaSelect();
  renderCategorias();
})();
</script>
</body>
</html>