<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Segmentar Clientes - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .small-muted { font-size:0.9rem; color:#6c757d; }
    .segment-row { border-bottom:1px solid #e9ecef; padding:10px 0; }
  </style>
</head>
<body class="bg-light">
<div class="container mt-4">
  <h5>Segmentación de clientes</h5>
  <p class="small-muted">Define criterios y guarda segmentos para campañas futuras.</p>

  <div class="card mb-3">
    <div class="card-body">
      <h6 class="mb-3">Criterios</h6>

      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label">Edad</label>
          <div class="d-flex gap-2">
            <input type="number" id="edadMin" class="form-control" placeholder="Min" min="0" />
            <input type="number" id="edadMax" class="form-control" placeholder="Max" min="0" />
          </div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Ubicación</label>
          <input type="text" id="ubicacion" class="form-control" placeholder="Ej: Santiago" />
        </div>

        <div class="col-12 col-md-4 text-md-end">
          <button class="btn btn-outline-secondary me-2" onclick="limpiarCriterios()">Limpiar</button>
          <button class="btn btn-primary" onclick="aplicarPrevisualizar()">Previsualizar</button>
        </div>
      </div>

      <div id="previewArea" class="mt-3 d-none">
        <div id="previewMsg" class="small-muted mb-2"></div>
        <div id="previewList" class="mb-2"></div>
        <div class="d-flex gap-2">
          <input id="segmentName" class="form-control" placeholder="Nombre del segmento (ej: Jóvenes en Santiago)" />
          <button class="btn btn-success" onclick="crearSegmento()">Crear segmento</button>
        </div>
      </div>

      <div id="critError" class="mt-2 text-danger d-none"></div>
      <div id="critSuccess" class="mt-2 text-success d-none"></div>
    </div>
  </div>

  <div class="mb-2 d-flex justify-content-between align-items-center">
    <h6 class="mb-0">Segmentos creados</h6>
    <button class="btn btn-sm btn-outline-secondary" onclick="recargarSegmentos()">Recargar</button>
  </div>

  <div id="segmentsList" class="mb-4 card p-3">
    <!-- segmentos inyectados -->
  </div>
</div>

<script>

const CLIENTES_KEY = "bb_clientes";
const SEGMENTS_KEY = "bb_segmentos";

function loadClientes() {
  try { return JSON.parse(localStorage.getItem(CLIENTES_KEY) || "[]"); }
  catch { return []; }
}

function loadSegmentos() {
  try { return JSON.parse(localStorage.getItem(SEGMENTS_KEY) || "[]"); }
  catch { return []; }
}
function saveSegmentos(arr) { localStorage.setItem(SEGMENTS_KEY, JSON.stringify(arr)); }

function limpiarCriterios() {
  document.getElementById("edadMin").value = "";
  document.getElementById("edadMax").value = "";
  document.getElementById("ubicacion").value = "";
  document.getElementById("previewArea").classList.add("d-none");
  hideMessages();
}

function hideMessages() {
  document.getElementById("critError").classList.add("d-none");
  document.getElementById("critSuccess").classList.add("d-none");
}

function aplicarPrevisualizar() {
  hideMessages();
  const min = parseInt(document.getElementById("edadMin").value,10);
  const max = parseInt(document.getElementById("edadMax").value,10);
  const ubic = (document.getElementById("ubicacion").value || "").trim();

  if (isNaN(min) && isNaN(max) && !ubic) {
    document.getElementById("critError").textContent = "Debe seleccionar al menos un criterio de segmentación";
    document.getElementById("critError").classList.remove("d-none");
    return;
  }

  const clientes = loadClientes();
  const filtered = clientes.filter(c => {
    if (!isNaN(min)) {
      if (!c.edad || c.edad < min) return false;
    }
    if (!isNaN(max)) {
      if (!c.edad || c.edad > max) return false;
    }
    if (ubic) {
      const loc = (c.ubicacion || c.direccion || "").toString().toLowerCase();
      if (!loc.includes(ubic.toLowerCase())) return false;
    }
    return true;
  });

  document.getElementById("previewArea").classList.remove("d-none");
  document.getElementById("previewMsg").textContent = `Clientes encontrados: ${filtered.length}`;
  const list = document.getElementById("previewList");
  list.innerHTML = "";
  if (filtered.length === 0) {
    list.innerHTML = `<div class="small-muted">No hay clientes que cumplan los criterios.</div>`;
  } else {
    filtered.slice(0,50).forEach(c => {
      const div = document.createElement("div");
      div.className = "segment-row";
      div.textContent = `${c.nombre || "(sin nombre)"} — ${c.edad ? c.edad + " años" : "edad N/D"} — ${c.ubicacion || c.direccion || "ubicación N/D"}`;
      list.appendChild(div);
    });
  }
}

function crearSegmento() {
  hideMessages();
  const name = (document.getElementById("segmentName").value || "").trim();
  const min = parseInt(document.getElementById("edadMin").value,10);
  const max = parseInt(document.getElementById("edadMax").value,10);
  const ubic = (document.getElementById("ubicacion").value || "").trim();

  if (!name) {
    document.getElementById("critError").textContent = "Debe ingresar un nombre para el segmento";
    document.getElementById("critError").classList.remove("d-none");
    return;
  }
  if (isNaN(min) && isNaN(max) && !ubic) {
    document.getElementById("critError").textContent = "Debe seleccionar al menos un criterio de segmentación";
    document.getElementById("critError").classList.remove("d-none");
    return;
  }

  const segmento = {
    id: "s-" + Math.random().toString(36).slice(2,9),
    nombre: name,
    criterios: {
      edadMin: isNaN(min) ? null : min,
      edadMax: isNaN(max) ? null : max,
      ubicacion: ubic || null
    },
    creadoEn: Date.now()
  };

  const segmentos = loadSegmentos();
  segmentos.push(segmento);
  saveSegmentos(segmentos);

  document.getElementById("critSuccess").textContent = "Segmento creado exitosamente";
  document.getElementById("critSuccess").classList.remove("d-none");
  renderSegmentos();
}

function renderSegmentos() {
  const cont = document.getElementById("segmentsList");
  const segmentos = loadSegmentos();
  cont.innerHTML = "";
  if (!segmentos || segmentos.length === 0) {
    cont.innerHTML = `<div class="small-muted">No hay segmentos guardados.</div>`;
    return;
  }
  segmentos.forEach(s => {
    const row = document.createElement("div");
    row.className = "d-flex justify-content-between align-items-center mb-2";
    const crit = [];
    if (s.criterios.edadMin !== null || s.criterios.edadMax !== null) {
      crit.push(`Edad: ${s.criterios.edadMin || '-'} - ${s.criterios.edadMax || '-'}`);
    }
    if (s.criterios.ubicacion) crit.push(`Ubicación: ${s.criterios.ubicacion}`);
    row.innerHTML = `
      <div>
        <div class="fw-semibold">${s.nombre}</div>
        <div class="small-muted">${crit.join(' · ')}</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" onclick="aplicarSegmento('${s.id}')">Aplicar</button>
        <button class="btn btn-sm btn-outline-danger" onclick="eliminarSegmento('${s.id}')">Eliminar</button>
      </div>
    `;
    cont.appendChild(row);
  });
}

function aplicarSegmento(id) {
  const segmentos = loadSegmentos();
  const s = segmentos.find(x => x.id === id);
  if (!s) return alert("Segmento no encontrado");
  document.getElementById("edadMin").value = s.criterios.edadMin !== null ? s.criterios.edadMin : "";
  document.getElementById("edadMax").value = s.criterios.edadMax !== null ? s.criterios.edadMax : "";
  document.getElementById("ubicacion").value = s.criterios.ubicacion || "";
  document.getElementById("segmentName").value = s.nombre;
  aplicarPrevisualizar();
}

function eliminarSegmento(id) {
  if (!confirm("Eliminar segmento?")) return;
  const segmentos = loadSegmentos().filter(s => s.id !== id);
  saveSegmentos(segmentos);
  renderSegmentos();
}

function seedClientesParaSegmentacion() {
  const existing = loadClientes();
  const ejemplos = [
    { nombre: "Camila Rojas", email: "camila.rojas@ejemplo.com", edad: 29, ubicacion: "Santiago", direccion: "Maipú", creadoEn: Date.now() },
    { nombre: "Luis Ramirez", email: "luis.ramirez@ejemplo.com", edad: 34, ubicacion: "Santiago", direccion: "Calle Falsa 123", creadoEn: Date.now() },
    { nombre: "Cliente Otro", email: "otro@ejemplo.com", edad: 45, ubicacion: "Valparaíso", direccion: "Valparaíso", creadoEn: Date.now() }
  ];
  const emails = existing.map(c => c.email);
  ejemplos.forEach(e => {
    if (!emails.includes(e.email)) existing.push(e);
  });
  localStorage.setItem(CLIENTES_KEY, JSON.stringify(existing));
}

function recargarSegmentos() { renderSegmentos(); hideMessages(); }

(function init() {
  seedClientesParaSegmentacion();
  renderSegmentos();
})();
</script>
</body>
</html>