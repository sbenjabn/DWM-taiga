<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historial de Accesos - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .user-item { cursor: pointer; }
    .user-item.active { background:#e9f5ff; }
    .alert-threshold { display: none; }
    .small-muted { font-size:0.9rem; color:#6c757d; }
  </style>
</head>
<body class="bg-light">
<div class="container mt-4">
  <div class="row">
    <!-- Panel izquierdo: Lista de usuarios -->
    <div class="col-12 col-md-3 mb-3">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Usuarios</h6>
          <div id="usuariosList" class="list-group">
            <!-- Usuarios inyectados por JS -->
          </div>
          <div class="mt-3">
            <input id="buscarUsuario" class="form-control form-control-sm" placeholder="Buscar usuario" oninput="filtrarUsuariosLista()" />
          </div>
        </div>
      </div>
    </div>

    <!-- Panel derecho: Tabla de historial -->
    <div class="col-12 col-md-9">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Historial de accesos</h5>
        <div>
          <button class="btn btn-sm btn-success me-2" onclick="simularAccesoExitoso()">Simular acceso exitoso</button>
          <button class="btn btn-sm btn-danger" onclick="simularIntentoFallido()">Simular intento fallido</button>
        </div>
      </div>

      <div id="alertThreshold" class="alert alert-warning alert-threshold">Alerta: Umbral de intentos fallidos superado para este usuario</div>

      <!-- Filtros rápidos -->
      <div class="mb-2 small-muted">Filtra por módulo:
        <select id="filtroModulo" onchange="renderHistorial()" class="form-select form-select-sm d-inline-block w-auto ms-2">
          <option value="">Todos</option>
          <option>Gestión de pedidos</option>
          <option>Módulo de ventas</option>
          <option>Panel de administración</option>
          <option>Inventario</option>
        </select>
      </div>

      <!-- Encabezados de la tabla -->
      <div class="row fw-bold border-bottom py-2">
        <div class="col-2">Fecha</div>
        <div class="col-2">Hora</div>
        <div class="col-2">IP</div>
        <div class="col-3">Módulo / Dispositivo</div>
        <div class="col-3">Resultado</div>
      </div>

      <!-- Contenedor de filas -->
      <div id="historialBody" class="mt-2">
        <!-- filas inyectadas -->
      </div>
    </div>
  </div>
</div>

<script>

const DEFAULT_IP = "192.168.1.45";
const THRESHOLD_FALLIDOS = 3;

const USUARIOS = [
  { nombre: "Luis Ramírez" },
  { nombre: "Camila Rojas" }
];

let historial = [];

const fallidosConsecutivos = {};

function init() {
  renderUsuarios();
  registrarEvento("Luis Ramírez", true, "Gestión de pedidos", "Chrome on Windows", DEFAULT_IP);
  selectUsuario(USUARIOS[0].nombre);
}

function renderUsuarios(filter = "") {
  const cont = document.getElementById("usuariosList");
  cont.innerHTML = "";
  USUARIOS.filter(u => u.nombre.toLowerCase().includes(filter.toLowerCase()))
          .forEach(u => {
    const div = document.createElement("div");
    div.className = "list-group-item list-group-item-action user-item";
    div.textContent = u.nombre;
    div.dataset.nombre = u.nombre;
    div.onclick = () => selectUsuario(u.nombre);
    cont.appendChild(div);
  });
}

function filtrarUsuariosLista() {
  const q = document.getElementById("buscarUsuario").value.trim();
  renderUsuarios(q);
}

let usuarioSeleccionado = null;
function selectUsuario(nombre) {
  usuarioSeleccionado = nombre;
  document.querySelectorAll("#usuariosList .user-item").forEach(el => {
    el.classList.toggle("active", el.dataset.nombre === nombre);
  });
  document.getElementById("alertThreshold").style.display = "none";
  renderHistorial();
}

function registrarEvento(usuario, exito, modulo = "Gestión de pedidos", dispositivo = "Web", ip = DEFAULT_IP, motivo = "") {
  const now = Date.now();
  historial.unshift({
    usuario,
    date: now,
    ip,
    modulo,
    dispositivo,
    exito,
    motivo
  });

  if (!exito) {
    fallidosConsecutivos[usuario] = (fallidosConsecutivos[usuario] || 0) + 1;
  } else {
    fallidosConsecutivos[usuario] = 0;
  }

  if ((fallidosConsecutivos[usuario] || 0) >= THRESHOLD_FALLIDOS) {
    if (usuario === usuarioSeleccionado) {
      document.getElementById("alertThreshold").style.display = "block";
    }
    console.warn(`Alerta: ${usuario} superó ${THRESHOLD_FALLIDOS} intentos fallidos.`);
  }

  renderHistorial();
}

function renderHistorial() {
  const cont = document.getElementById("historialBody");
  cont.innerHTML = "";

  if (!usuarioSeleccionado) {
    cont.innerHTML = `<div class="py-3 text-muted small">Selecciona un usuario a la izquierda para ver su historial.</div>`;
    return;
  }

  const filtroModulo = document.getElementById("filtroModulo").value;
  const eventos = historial.filter(h => h.usuario === usuarioSeleccionado && (!filtroModulo || h.modulo === filtroModulo));

  if (eventos.length === 0) {
    cont.innerHTML = `<div class="py-3 text-muted small">No hay registros para ${usuarioSeleccionado}.</div>`;
    return;
  }

  eventos.forEach(ev => {
    const d = new Date(ev.date);
    const fecha = d.toLocaleDateString();
    const hora = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
    const row = document.createElement("div");
    row.className = "row border-bottom py-2 align-items-center";
    row.innerHTML = `
      <div class="col-2">${fecha}</div>
      <div class="col-2">${hora}</div>
      <div class="col-2">${ev.ip}</div>
      <div class="col-3"><strong>${ev.modulo}</strong><div class="small-muted">${ev.dispositivo}</div></div>
      <div class="col-3">${ev.exito ? '<span class="badge bg-success">Éxito</span>' : '<span class="badge bg-danger">Intento fallido</span>'} ${ev.motivo ? `<div class="small text-muted mt-1">${ev.motivo}</div>` : ''}</div>
    `;
    cont.appendChild(row);
  });

  if ((fallidosConsecutivos[usuarioSeleccionado] || 0) >= THRESHOLD_FALLIDOS) {
    document.getElementById("alertThreshold").style.display = "block";
  } else {
    document.getElementById("alertThreshold").style.display = "none";
  }
}

function simularAccesoExitoso() {
  if (!usuarioSeleccionado) { alert("Selecciona un usuario a la izquierda."); return; }
  registrarEvento(usuarioSeleccionado, true, "Gestión de pedidos", "Chrome on Windows", DEFAULT_IP);
  alert(`Registrado: acceso exitoso de ${usuarioSeleccionado}`);
}

function simularIntentoFallido() {
  if (!usuarioSeleccionado) { alert("Selecciona un usuario a la izquierda."); return; }
  registrarEvento(usuarioSeleccionado, false, "Gestión de pedidos", "Chrome on Windows", DEFAULT_IP, "Credenciales inválidas");
  alert(`Registrado: intento fallido para ${usuarioSeleccionado}`);
}

window.addEventListener("message", (e) => {
  try {
    const data = typeof e.data === "string" ? JSON.parse(e.data) : e.data;
    if (data && data.type === "registro" && data.payload && data.payload.usuario) {
      const p = data.payload;
      registrarEvento(p.usuario, !!p.exito, p.modulo || "Gestión de pedidos", p.dispositivo || "Web", p.ip || DEFAULT_IP, p.motivo || "");
    }
  } catch (err) {}
}, false);

init();
</script>
</body>
</html>