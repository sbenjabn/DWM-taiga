<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumen de Pedido - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .muted-small { font-size:0.9rem; color:#6c757d; }
    .line { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee; }
    .total-line { font-weight:700; font-size:1.1rem; }
    .small-note { font-size:0.85rem; color:#6c757d; }
    .modifier { font-style:italic; color:#495057; font-size:0.95rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-4 mb-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h5 id="pedidoNumero">Pedido #—</h5>
            <div id="pedidoTipo" class="muted-small"></div>
          </div>
          <div class="text-end">
            <div class="small-note">Estado: <span id="pedidoEstado">Pendiente</span></div>
            <div class="small-note">Estimado: <span id="pedidoEstimado">—</span></div>
          </div>
        </div>

        <div class="mb-2">
          <div class="line fw-semibold">
            <div>Producto</div>
            <div class="text-end">Precio</div>
          </div>
        </div>

        <div id="itemsContainer"></div>

        <div class="mt-3">
          <div class="line total-line">
            <div>Total</div>
            <div id="totalMonto" class="text-end">$ 0</div>
          </div>
          <div id="tiempoPreparacion" class="small-note mt-2"></div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button id="btnVolver" class="btn btn-outline-secondary" onclick="history.back()">Volver</button>
          <div>
            <button id="btnConfirmar" class="btn btn-primary me-2" onclick="confirmarPedido()">Confirmar</button>
            <button id="btnModificar" class="btn btn-outline-secondary" onclick="modificarPedido()">Modificar</button>
          </div>
        </div>

        <div id="msgArea" class="mt-3"></div>
      </div>
    </div>
  </div>

<script>

const CURRENT_KEY = "bb_current_order";
const ORDERS_KEY = "bb_orders";

function loadCurrentOrder() {
  try {
    const raw = localStorage.getItem(CURRENT_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
function saveOrderToHistory(order) {
  try {
    const arr = JSON.parse(localStorage.getItem(ORDERS_KEY) || "[]");
    arr.unshift(order);
    localStorage.setItem(ORDERS_KEY, JSON.stringify(arr));
  } catch (e) {
    console.error(e);
  }
}

function seedExampleOrder() {
  const now = Date.now();
  const example = {
    id: "o-" + Math.random().toString(36).slice(2,9),
    tipo: "virtual",
    productos: [
      { nombre:"Hamburguesa queso", modificadores: [], precio:5990, cantidad:1 },
      { nombre:"Papas medianas", modificadores: [], precio:1990, cantidad:1 },
      { nombre:"Coca Cola", modificadores: [], precio:1200, cantidad:1 }
    ],
    creadoEn: now,
    estado: "pendiente"
  };
  localStorage.setItem(CURRENT_KEY, JSON.stringify(example));
  return example;
}

function calcularEstimado(order) {
  if (!order) return "—";
  const base = 10;
  const perItem = 3;
  const presencialExtra = order.tipo === "presencial" ? 2 : 0;
  const qty = (order.productos || []).reduce((s,i)=> s + (i.cantidad||1), 0);
  const mins = base + perItem * qty + presencialExtra;
  return `${mins} min`;
}

function renderResumen() {
  let order = loadCurrentOrder();
  if (!order) order = seedExampleOrder();

  document.getElementById("pedidoNumero").textContent = `Pedido ${order.id || ''}`;
  document.getElementById("pedidoTipo").textContent = order.tipo === "presencial" ? "Caja presencial" : "Cajero virtual";
  document.getElementById("pedidoEstado").textContent = capitalize(order.estado || "pendiente");
  document.getElementById("pedidoEstimado").textContent = calcularEstimado(order);

  const container = document.getElementById("itemsContainer");
  container.innerHTML = "";
  let total = 0;
  (order.productos || []).forEach(item => {
    const montoItem = Number(item.precio || 0) * (item.cantidad || 1);
    total += montoItem;
    const row = document.createElement("div");
    row.className = "line";
    const nameHtml = document.createElement("div");
    nameHtml.innerHTML = `<div>${escapeHtml(item.nombre)} ${item.modificadores && item.modificadores.length ? `<div class="modifier">${escapeHtml(item.modificadores.join(", "))}</div>` : ""}</div>`;
    const priceHtml = document.createElement("div");
    priceHtml.className = "text-end";
    priceHtml.textContent = `$ ${Number(montoItem).toLocaleString()}`;
    row.appendChild(nameHtml);
    row.appendChild(priceHtml);
    container.appendChild(row);
  });

  document.getElementById("totalMonto").textContent = `$ ${Number(total).toLocaleString()}`;
  document.getElementById("tiempoPreparacion").textContent = `Tiempo estimado de preparación: ${calcularEstimado(order)}.`;
}

function confirmarPedido() {
  const order = loadCurrentOrder();
  if (!order) return alert("No hay pedido para confirmar.");
  order.estado = "confirmado";
  order.confirmadoEn = Date.now();
  saveOrderToHistory(order);
  localStorage.removeItem(CURRENT_KEY);
  document.getElementById("pedidoEstado").textContent = "Confirmado";
  showMessage("Pedido confirmado. Se ha guardado en el historial.", "success");
  setTimeout(()=> {
  }, 800);
}

function modificarPedido() {
  history.back();
}

let _msgTimer = null;
function showMessage(text, type='info') {
  clearTimeout(_msgTimer);
  const area = document.getElementById("msgArea");
  area.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
  _msgTimer = setTimeout(()=> area.innerHTML = "", 3000);
}
function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase() + s.slice(1); }

(function init(){
  renderResumen();
})();
</script>
</body>
</html>