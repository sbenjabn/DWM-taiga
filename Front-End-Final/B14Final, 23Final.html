<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumen de Pedido - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .muted-small { font-size:0.9rem; color:#6c757d; }
    .line { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee; }
    .total-line { font-weight:700; font-size:1.1rem; }
    .small-note { font-size:0.85rem; color:#6c757d; }
    .badge-paid { background:#d1e7dd; color:#0f5132; padding:4px 8px; border-radius:8px; }
    .badge-failed { background:#f8d7da; color:#842029; padding:4px 8px; border-radius:8px; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-4 mb-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h5 id="pedidoNumero">Pedido #—</h5>
            <div id="pedidoTipo" class="muted-small"></div>
          </div>
          <div class="text-end">
            <div class="small-note">Estado: <span id="pedidoEstado">Pendiente</span></div>
            <div class="small-note">Estimado: <span id="pedidoEstimado">—</span></div>
            <div id="paymentStatusWrap" class="mt-1"></div>
          </div>
        </div>

        <div class="mb-2">
          <div class="line fw-semibold">
            <div>Producto</div>
            <div class="text-end">Precio</div>
          </div>
        </div>

        <div id="itemsContainer"></div>

        <div class="mt-3">
          <div class="line total-line">
            <div>Total</div>
            <div id="totalMonto" class="text-end">$ 0</div>
          </div>
          <div id="tiempoPreparacion" class="small-note mt-2"></div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button id="btnVolver" class="btn btn-outline-secondary" onclick="history.back()">Volver</button>
          <div>
            <button id="btnSimularPagoExito" class="btn btn-success me-2" onclick="processPayment(true)">Simular pago exitoso</button>
            <button id="btnSimularPagoFallo" class="btn btn-danger me-2" onclick="processPayment(false)">Simular pago fallido</button>
            <button id="btnConfirmar" class="btn btn-primary me-2" onclick="confirmarPedido()">Confirmar</button>
            <button id="btnModificar" class="btn btn-outline-secondary" onclick="modificarPedido()">Modificar</button>
          </div>
        </div>

        <div id="dispatchInfo" class="mt-3"></div>
        <div id="msgArea" class="mt-3"></div>
      </div>
    </div>
  </div>

<script>
const CURRENT_KEY = "bb_current_order";
const ORDERS_KEY = "bb_orders";
const DISPATCH_KEY = "bb_dispatch_orders";

function loadCurrentOrder() {
  try { const raw = localStorage.getItem(CURRENT_KEY); if (!raw) return null; return JSON.parse(raw); } catch { return null; }
}
function saveCurrentOrder(o) { try { localStorage.setItem(CURRENT_KEY, JSON.stringify(o)); } catch(e){ console.error(e); } }
function saveOrderToHistory(order) {
  try { const arr = JSON.parse(localStorage.getItem(ORDERS_KEY) || "[]"); arr.unshift(order); localStorage.setItem(ORDERS_KEY, JSON.stringify(arr)); } catch(e) { console.error(e); }
}
function saveDispatchOrder(dispatch) {
  try { const arr = JSON.parse(localStorage.getItem(DISPATCH_KEY) || "[]"); arr.unshift(dispatch); localStorage.setItem(DISPATCH_KEY, JSON.stringify(arr)); } catch(e) { console.error(e); }
}

function seedExampleOrderIfMissing() {
  try {
    if (loadCurrentOrder()) return;
    const now = Date.now();
    const example = {
      id: "o-" + Math.random().toString(36).slice(2,9),
      tipo: "virtual",
      productos: [
        { nombre:"Hamburguesa queso", modificadores: [], precio:5990, cantidad:1 },
        { nombre:"Papas medianas", modificadores: [], precio:1990, cantidad:1 },
        { nombre:"Coca Cola", modificadores: [], precio:1200, cantidad:1 }
      ],
      creadoEn: now,
      estado: "pendiente",
      payment: { method: "tarjeta", status: "pending", providerRef: null }
    };
    saveCurrentOrder(example);
  } catch(e){ console.error(e); }
}

function calcularEstimado(order) {
  if (!order) return "—";
  const base = 10;
  const perItem = 3;
  const presencialExtra = order.tipo === "presencial" ? 2 : 0;
  const qty = (order.productos || []).reduce((s,i)=> s + (i.cantidad||1), 0);
  const mins = base + perItem * qty + presencialExtra;
  return `${mins} min`;
}

function renderResumen() {
  let order = loadCurrentOrder();
  if (!order) { seedExampleOrderIfMissing(); order = loadCurrentOrder(); }

  document.getElementById("pedidoNumero").textContent = `Pedido ${order.id || ''}`;
  document.getElementById("pedidoTipo").textContent = order.tipo === "presencial" ? "Caja presencial" : "Cajero virtual";
  document.getElementById("pedidoEstado").textContent = capitalize(order.estado || "pendiente");
  document.getElementById("pedidoEstimado").textContent = calcularEstimado(order);

  const payWrap = document.getElementById("paymentStatusWrap");
  payWrap.innerHTML = "";
  if (order.payment) {
    const span = document.createElement("span");
    if (order.payment.status === "success") { span.className = "badge-paid"; span.textContent = "Pago procesado"; }
    else if (order.payment.status === "failed") { span.className = "badge-failed"; span.textContent = "Pago no procesado"; }
    else { span.className = "muted-small"; span.textContent = "Pago: pendiente"; }
    payWrap.appendChild(span);
  }

  const container = document.getElementById("itemsContainer");
  container.innerHTML = "";
  let total = 0;
  (order.productos || []).forEach(item => {
    const montoItem = Number(item.precio || 0) * (item.cantidad || 1);
    total += montoItem;
    const row = document.createElement("div");
    row.className = "line";
    const nameHtml = document.createElement("div");
    nameHtml.innerHTML = `<div>${escapeHtml(item.nombre)} ${item.modificadores && item.modificadores.length ? `<div class="small-note">${escapeHtml(item.modificadores.join(", "))}</div>` : ""}</div>`;
    const priceHtml = document.createElement("div");
    priceHtml.className = "text-end";
    priceHtml.textContent = `$ ${Number(montoItem).toLocaleString()}`;
    row.appendChild(nameHtml);
    row.appendChild(priceHtml);
    container.appendChild(row);
  });

  document.getElementById("totalMonto").textContent = `$ ${Number(total).toLocaleString()}`;
  document.getElementById("tiempoPreparacion").textContent = `Tiempo estimado de preparación: ${calcularEstimado(order)}.`;

  renderDispatchInfoForOrder(order.id);
}

function renderDispatchInfoForOrder(orderId) {
  const wrap = document.getElementById("dispatchInfo");
  wrap.innerHTML = "";
  const dispatches = JSON.parse(localStorage.getItem(DISPATCH_KEY) || "[]");
  const d = dispatches.find(x => x.orderId === orderId);
  if (d) {
    const card = document.createElement("div");
    card.className = "alert alert-success";
    card.innerHTML = `<strong>Orden de despacho generada</strong><div>Dispatch ID: ${escapeHtml(d.id)}</div><div class="small-note">Asignado a: Cocina - ${escapeHtml(d.assigned.kitchen)}; Despacho - ${escapeHtml(d.assigned.delivery)}</div><div class="small-note mt-1">Creada: ${new Date(d.createdAt).toLocaleString()}</div>`;
    wrap.appendChild(card);
  }
}

function processPayment(success = true) {
  const order = loadCurrentOrder();
  if (!order) return showMessage("No hay pedido activo para procesar pago", "danger");
  order.payment = order.payment || { method: "tarjeta", status: "pending" };
  if (success) {
    order.payment.status = "success";
    order.payment.providerRef = "TXN-" + Math.random().toString(36).slice(2,9).toUpperCase();
    saveCurrentOrder(order);
    renderResumen();
    showMessage("Pago simulado: exitoso", "success");
    generateDispatchOrderIfNeeded(order);
  } else {
    order.payment.status = "failed";
    order.payment.providerRef = null;
    saveCurrentOrder(order);
    renderResumen();
    showMessage("Pago simulado: fallido", "danger");
  }
}

function confirmarPedido() {
  const order = loadCurrentOrder();
  if (!order) return alert("No hay pedido para confirmar.");
  if (order.tipo === "virtual") {
    if (!order.payment || order.payment.status !== "success") {
      showMessage("Pago no procesado, intente nuevamente", "danger");
      return;
    }
  }
  order.estado = "confirmado";
  order.confirmadoEn = Date.now();
  saveOrderToHistory(order);
  generateDispatchOrderIfNeeded(order);
  localStorage.removeItem(CURRENT_KEY);
  document.getElementById("pedidoEstado").textContent = "Confirmado";
  showMessage("Pedido confirmado. Se ha guardado en el historial.", "success");

  setTimeout(() => {
    window.location.href = 'B16Final.html';
  }, 700);
}

function modificarPedido() { history.back(); }

function generateDispatchOrderIfNeeded(order) {
  try {
    if (!order) return;
    if (order.tipo === "virtual" && (!order.payment || order.payment.status !== "success")) return;
    const existing = JSON.parse(localStorage.getItem(DISPATCH_KEY) || "[]").find(d => d.orderId === order.id);
    if (existing) return;
    const dispatch = {
      id: "D-" + Math.random().toString(36).slice(2,9).toUpperCase(),
      orderId: order.id,
      items: order.productos || [],
      assigned: { kitchen: pickKitchenTeam(), delivery: pickDeliveryTeam() },
      createdAt: Date.now(),
      status: "assigned"
    };
    saveDispatchOrder(dispatch);
    renderDispatchInfoForOrder(order.id);
    showMessage("Orden de despacho generada y asignada al equipo", "success");
  } catch(e) { console.error(e); }
}

function pickKitchenTeam() { const teams = ["Equipo A","Equipo B","Equipo C"]; return teams[Math.floor(Math.random()*teams.length)]; }
function pickDeliveryTeam() { const teams = ["Reparto 1","Reparto 2","Reparto 3"]; return teams[Math.floor(Math.random()*teams.length)]; }

function showMessage(text, type='info') {
  const area = document.getElementById("msgArea");
  area.innerHTML = `<div class="alert alert-${type}">${escapeHtml(text)}</div>`;
  setTimeout(()=> area.innerHTML = "", 3500);
}
function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase() + s.slice(1); }

(function init(){
  seedExampleOrderIfMissing();
  renderResumen();
})();
</script>
</body>
</html>