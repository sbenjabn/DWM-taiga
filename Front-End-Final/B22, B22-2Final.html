<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Visualización - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .muted-small { font-size:0.9rem; color:#6c757d; }
    .card-title { font-weight:600; }
    .metrics { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    .metric { background:#f8f9fa; padding:10px 12px; border-radius:8px; min-width:140px; }
    .chart-wrap { width:100%; height:260px; background:#fff; border-radius:8px; padding:12px; box-shadow:0 0 0 1px rgba(0,0,0,0.03); }
    .table-wrap { max-height:320px; overflow:auto; }
    .controls { display:flex; gap:8px; align-items:center; }
    .badge-state-prep { background:#fff3cd; color:#856404; padding:6px 8px; border-radius:8px; }
    .badge-state-listo { background:#d1e7dd; color:#0f5132; padding:6px 8px; border-radius:8px; }
    .badge-state-desp { background:#cfe2ff; color:#084298; padding:6px 8px; border-radius:8px; }
    canvas { width:100%; height:230px; display:block; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Panel de Visualización</h4>
      <div class="muted-small">Módulos: Ventas / Pedidos en curso</div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label small mb-1">Módulo</label>
            <select id="moduleSel" class="form-select" onchange="renderModule()">
              <option value="ventas">Ventas</option>
              <option value="pedidos">Pedidos en curso</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small mb-1">Fecha</label>
            <input id="viewDate" type="date" class="form-control" />
          </div>
          <div class="col-md-6 d-grid">
            <button class="btn btn-primary" onclick="renderModule()">Actualizar vista</button>
          </div>
        </div>
        <div class="mt-2 muted-small">Datos de prueba disponibles para demostración</div>
      </div>
    </div>

    <!-- Ventas -->
    <div id="ventasPanel" class="card mb-3 d-none">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="card-title">Ventas por hora (día seleccionado)</div>
          <div class="controls">
            <div id="totalAcum" class="metric"></div>
            <div id="ticketProm" class="metric"></div>
            <div id="topProductos" class="metric"></div>
          </div>
        </div>

        <div class="chart-wrap mb-3">
          <canvas id="hourChart"></canvas>
        </div>

        <div class="fw-semibold mb-1">Detalles por transacción</div>
        <div class="table-wrap">
          <table class="table table-sm table-striped">
            <thead><tr><th>Hora</th><th>Producto</th><th>Vendedor</th><th>Monto</th></tr></thead>
            <tbody id="ventasTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Pedidos en curso -->
    <div id="pedidosPanel" class="card mb-3 d-none">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="card-title">Pedidos en curso</div>
          <div class="muted-small">Muestra pedidos activos y tiempos estimados</div>
        </div>

        <div class="table-wrap">
          <table class="table table-sm table-hover">
            <thead><tr><th>ID</th><th>Cliente</th><th>Estado</th><th>Tiempo estimado</th><th>Encargado</th></tr></thead>
            <tbody id="pedidosTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <div><button class="btn btn-outline-secondary" onclick="history.back()">Atrás</button></div>
      <div><button class="btn btn-outline-primary" onclick="toggleModule()">Cambiar módulo</button></div>
    </div>

    <div id="msgArea" class="mt-3"></div>
  </div>

<script>

const SAMPLE_KEY = "B22_SAMPLES_V1";

function seedSamples() {
  try {
    if (localStorage.getItem(SAMPLE_KEY)) return;
    const samples = { ventas: [], pedidos: [] };
    const dateBase = new Date().toISOString().slice(0,10);

    const productos = ["Hamburguesa queso","Papas medianas","Coca Cola","Helado de vainilla San Francisco"];
    const vendedores = ["Laura Pérez","Marcos Díaz","Ana Gómez"];

    for (let h = 8; h <= 22; h++) {
      const count = Math.floor(Math.random()*6);
      for (let i=0;i<count;i++) {
        const prod = productos[Math.floor(Math.random()*productos.length)];
        const vend = vendedores[Math.floor(Math.random()*vendedores.length)];
        const monto = prod === "Helado de vainilla San Francisco" ? 2500
                    : prod === "Coca Cola" ? 1200
                    : prod === "Papas medianas" ? 1990 : 5990;
        const minute = Math.floor(Math.random()*60).toString().padStart(2,'0');
        samples.ventas.push({
          date: dateBase,
          time: `${h.toString().padStart(2,'0')}:${minute}`,
          hour: h,
          producto: prod,
          vendedor: vend,
          monto
        });
      }
    }

    samples.ventas.push({
      date: dateBase, time: "12:05", hour:12, producto: "Helado de vainilla San Francisco", vendedor: "Laura Pérez", monto: 2500
    });
    samples.ventas.push({
      date: dateBase, time: "13:10", hour:13, producto: "Helado de vainilla San Francisco", vendedor: "Laura Pérez", monto: 5000
    });

    samples.pedidos = [
      { id: "P-1001", cliente: "Cliente A", estado: "En preparación", etaMin: 12, encargado: "Laura Pérez" },
      { id: "P-1002", cliente: "Cliente B", estado: "Listo", etaMin: 0, encargado: "Marcos Díaz" },
      { id: "P-1003", cliente: "Cliente C", estado: "Despachado", etaMin: 18, encargado: "Ana Gómez" },
      { id: "P-1004", cliente: "Cliente D", estado: "En preparación", etaMin: 7, encargado: "Laura Pérez" }
    ];

    localStorage.setItem(SAMPLE_KEY, JSON.stringify(samples));
  } catch(e){ console.error(e); }
}

function loadSamples() { try { return JSON.parse(localStorage.getItem(SAMPLE_KEY) || '{"ventas":[],"pedidos":[]}'); } catch { return { ventas:[], pedidos:[] }; } }

function renderModule() {
  const module = document.getElementById('moduleSel').value;
  const date = document.getElementById('viewDate').value || new Date().toISOString().slice(0,10);
  document.getElementById('ventasPanel').classList.toggle('d-none', module !== 'ventas');
  document.getElementById('pedidosPanel').classList.toggle('d-none', module !== 'pedidos');

  if (module === 'ventas') renderVentas(date);
  else renderPedidos();
}

function toggleModule() {
  const sel = document.getElementById('moduleSel');
  sel.value = sel.value === 'ventas' ? 'pedidos' : 'ventas';
  renderModule();
}

function renderVentas(date) {
  const samples = loadSamples().ventas.filter(v => v.date === date);
  const hours = Array.from({length:24}, (_,i)=> ({ h:i, total:0, count:0 }));
  samples.forEach(s => {
    const h = Number(s.hour);
    hours[h].total += s.monto;
    hours[h].count += 1;
  });

  const totalAcum = samples.reduce((s,i)=> s + i.monto, 0);
  const ticketProm = samples.length ? Math.round(totalAcum / samples.length) : 0;
  const prodMap = {};
  samples.forEach(s => { prodMap[s.producto] = (prodMap[s.producto]||0) + 1; });
  const top = Object.entries(prodMap).sort((a,b)=> b[1]-a[1]).slice(0,3).map(t=> `${t[0]} (${t[1]})`).join(', ') || '—';

  document.getElementById('totalAcum').innerHTML = `<div class="muted-small">Total acumulado</div><div class="fw-semibold">${formatCurrency(totalAcum)}</div>`;
  document.getElementById('ticketProm').innerHTML = `<div class="muted-small">Ticket promedio</div><div class="fw-semibold">${formatCurrency(ticketProm)}</div>`;
  document.getElementById('topProductos').innerHTML = `<div class="muted-small">Top productos</div><div class="fw-semibold">${escapeHtml(top)}</div>`;

  drawHourChart(hours);

  const tbody = document.getElementById('ventasTable');
  tbody.innerHTML = '';
  samples.sort((a,b)=> (a.hour - b.hour) || a.time.localeCompare(b.time)).forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.time}</td><td>${escapeHtml(s.producto)}</td><td>${escapeHtml(s.vendedor)}</td><td>${formatCurrency(s.monto)}</td>`;
    tbody.appendChild(tr);
  });

  if (samples.length === 0) {
    document.getElementById('ventasTable').innerHTML = `<tr><td colspan="4" class="muted-small">No hay ventas para la fecha seleccionada.</td></tr>`;
  }
}

function renderPedidos() {
  const pedidos = loadSamples().pedidos || [];
  const tbody = document.getElementById('pedidosTable');
  tbody.innerHTML = '';
  pedidos.forEach(p => {
    const tr = document.createElement('tr');
    let estadoBadge = '';
    if (p.estado === 'En preparación') estadoBadge = `<span class="badge-state-prep">${p.estado}</span>`;
    else if (p.estado === 'Listo') estadoBadge = `<span class="badge-state-listo">${p.estado}</span>`;
    else if (p.estado === 'Despachado') estadoBadge = `<span class="badge-state-desp">${p.estado}</span>`;
    else estadoBadge = escapeHtml(p.estado);

    tr.innerHTML = `<td>${escapeHtml(p.id)}</td><td>${escapeHtml(p.cliente)}</td><td>${estadoBadge}</td><td>${p.etaMin} min</td><td>${escapeHtml(p.encargado)}</td>`;
    tbody.appendChild(tr);
  });

  if (pedidos.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="muted-small">No hay pedidos en curso.</td></tr>`;
  }
}

function drawHourChart(hours) {
  const canvas = document.getElementById('hourChart');
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  const DPR = window.devicePixelRatio || 1;
  canvas.width = rect.width * DPR;
  canvas.height = rect.height * DPR;
  ctx.scale(DPR, DPR);
  ctx.clearRect(0,0,rect.width,rect.height);

  const padding = { top: 10, right: 16, bottom: 30, left: 36 };
  const w = rect.width - padding.left - padding.right;
  const h = rect.height - padding.top - padding.bottom;

  const displayHours = hours.slice(8,23);
  const values = displayHours.map(x => x.total);
  const maxVal = Math.max(1, ...values);
  const barWidth = w / displayHours.length * 0.7;
  const gap = (w / displayHours.length) * 0.3;

  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,rect.width,rect.height);

  ctx.strokeStyle = '#e9ecef';
  ctx.lineWidth = 1;
  const gridLines = 4;
  for (let i=0;i<=gridLines;i++) {
    const y = padding.top + (h * i / gridLines);
    ctx.beginPath();
    ctx.moveTo(padding.left, y);
    ctx.lineTo(padding.left + w, y);
    ctx.stroke();
  }

  displayHours.forEach((hourObj, idx) => {
    const x = padding.left + idx * (barWidth + gap) + gap/2;
    const barH = maxVal ? (hourObj.total / maxVal) * (h - 10) : 0;
    const y = padding.top + (h - barH);
    const grad = ctx.createLinearGradient(x, y, x, y + barH);
    grad.addColorStop(0, '#0d6efd');
    grad.addColorStop(1, '#198754');
    ctx.fillStyle = grad;
    ctx.fillRect(x, y, barWidth, barH);

    ctx.fillStyle = '#495057';
    ctx.font = '12px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
    ctx.textAlign = 'center';
    ctx.fillText(String(hourObj.h).padStart(2,'0'), x + barWidth/2, padding.top + h + 14);
    if (hourObj.total > 0) {
      ctx.fillStyle = '#212529';
      ctx.font = '11px system-ui, sans-serif';
      ctx.fillText(formatCurrencyShort(hourObj.total), x + barWidth/2, y - 6);
    }
  });

  ctx.fillStyle = '#6c757d';
  ctx.font = '12px system-ui, sans-serif';
  ctx.textAlign = 'right';
  ctx.fillText(formatCurrencyShort(maxVal), padding.left - 8, padding.top + 10);
  ctx.fillText(formatCurrencyShort(Math.round(maxVal/2)), padding.left - 8, padding.top + (h/2) + 4);
}

function formatCurrency(n){ return `$ ${Number(n||0).toLocaleString()}`; }
function formatCurrencyShort(n){
  if (n >= 1000) return `$ ${Math.round(n/1000)}k`;
  return `$ ${n}`;
}
function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function showMessage(text, type='info'){ const area = document.getElementById('msgArea'); area.innerHTML = `<div class="alert alert-${type}">${text}</div>`; setTimeout(()=> area.innerHTML = '', 3500); }

(function init(){
  seedSamples();
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('viewDate').value = today;
  document.getElementById('moduleSel').value = 'ventas';
  renderModule();
})();
</script>
</body>
</html>