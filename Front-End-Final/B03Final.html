<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recuperar Contraseña - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background:#f8f9fa; }
    .card { max-width:540px; margin:auto; }
  </style>
</head>
<body>
<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">¿Olvidaste tu contraseña?</h5>
      <p class="card-text">Ingresa tu dirección de correo electrónico y te enviaremos un enlace para restablecer tu contraseña.</p>

      <!-- Paso 1: solicitar email -->
      <div id="step-request">
        <label class="form-label">Correo electrónico</label>
        <input type="email" id="recEmail" class="form-control mb-3" placeholder="cliente@ejemplo.com">
        <div id="reqMsg" class="small text-success mb-2 d-none"></div>
        <div id="reqErr" class="small text-danger mb-2 d-none"></div>
        <button class="btn btn-primary w-100" onclick="enviarEnlace()">Enviar</button>
      </div>

      <!-- Paso 2: mensaje revisar correo -->
      <div id="step-sent" class="d-none">
        <div class="alert alert-info">Revisa tu correo para restablecer tu contraseña.</div>
        <p class="small text-muted">Para pruebas: el sistema muestra enlaces simulados abajo.</p>
        <div id="simLinks" class="mb-3"></div>
        <button class="btn btn-secondary w-100" onclick="volverARequest()">Volver</button>
      </div>

      <!-- Paso 3: token expirado -->
      <div id="step-expired" class="d-none">
        <div class="alert alert-warning">El enlace ha expirado, solicita uno nuevo.</div>
        <button class="btn btn-primary w-100 mb-2" onclick="volverARequest()">Solicitar nuevo enlace</button>
      </div>

      <!-- Paso 4: restablecer contraseña -->
      <div id="step-reset" class="d-none">
        <h6>Restablecer contraseña</h6>
        <div class="mb-2"><strong>Token:</strong> <span id="tokenShown"></span></div>
        <label class="form-label">Nueva contraseña</label>
        <input type="password" id="newPass" class="form-control mb-2" placeholder="Mínimo 8 caracteres">
        <label class="form-label">Confirmar contraseña</label>
        <input type="password" id="confirmPass" class="form-control mb-2" placeholder="Repite la contraseña">
        <div id="resetErr" class="small text-danger mb-2 d-none"></div>
        <div id="resetSuccess" class="small text-success mb-2 d-none"></div>
        <button class="btn btn-success w-100" onclick="restablecer()">Restablecer</button>
      </div>

      <!-- Mensaje final -->
      <div id="step-done" class="d-none">
        <div class="alert alert-success">Contraseña actualizada correctamente. Serás redirigido a la pantalla de inicio de sesión.</div>
        <button class="btn btn-primary w-100" onclick="irALogin()">Ir a Iniciar sesión</button>
      </div>
    </div>
  </div>
</div>

<script>

const TEST_EMAIL = "cliente@ejemplo.com";
const VALID_TOKEN = "abc123";
const EXPIRED_TOKEN = "xyz789";

const tokenStore = {
  [VALID_TOKEN]: { email: TEST_EMAIL, createdAt: Date.now() - (1000 * 60 * 60) }, // 1h ago
  [EXPIRED_TOKEN]: { email: TEST_EMAIL, createdAt: Date.now() - (1000 * 60 * 60 * 24 * 2) } // 48h ago
};

const userStore = {
  [TEST_EMAIL]: "Segura2025"
};

function mostrarPaso(id) {
  const pasos = ["step-request","step-sent","step-expired","step-reset","step-done"];
  pasos.forEach(p => document.getElementById(p).classList.add("d-none"));
  document.getElementById(id).classList.remove("d-none");
}

function enviarEnlace() {
  const email = document.getElementById("recEmail").value.trim().toLowerCase();
  const reqErr = document.getElementById("reqErr");
  const reqMsg = document.getElementById("reqMsg");
  reqErr.classList.add("d-none");
  reqMsg.classList.add("d-none");

  if (!email) {
    reqErr.textContent = "Ingresa un correo válido.";
    reqErr.classList.remove("d-none");
    return;
  }

  if (email !== TEST_EMAIL) {
    reqErr.textContent = "Si el correo está registrado, recibirás un enlace. (simulación)";
    reqErr.classList.remove("d-none");
    return;
  }

  const newToken = VALID_TOKEN;
  tokenStore[newToken] = { email, createdAt: Date.now() };

  mostrarPaso("step-sent");
  const simLinks = document.getElementById("simLinks");
  simLinks.innerHTML = "";

  const validLink = crearEnlaceHTML(newToken, "Enlace válido (abc123)");
  const expiredLink = crearEnlaceHTML(EXPIRED_TOKEN, "Enlace expirado (xyz789)");
  simLinks.appendChild(validLink);
  simLinks.appendChild(expiredLink);

  reqMsg.textContent = "Revisa tu correo para restablecer tu contraseña.";
  reqMsg.classList.remove("d-none");
}

function crearEnlaceHTML(token, label) {
  const wrapper = document.createElement("div");
  wrapper.className = "mb-2";
  const a = document.createElement("a");
  a.href = "#";
  a.textContent = label;
  a.onclick = (e) => { e.preventDefault(); abrirLinkToken(token); };
  wrapper.appendChild(a);
  return wrapper;
}

function abrirLinkToken(token) {
  if (!tokenStore[token]) {
    mostrarPaso("step-expired");
    return;
  }
  const created = tokenStore[token].createdAt;
  const now = Date.now();
  const ms24 = 24 * 60 * 60 * 1000;
  if ((now - created) > ms24) {
    mostrarPaso("step-expired");
    return;
  }
  document.getElementById("tokenShown").textContent = token;
  mostrarPaso("step-reset");
}

function restablecer() {
  const token = document.getElementById("tokenShown").textContent.trim();
  const pass = document.getElementById("newPass").value;
  const confirm = document.getElementById("confirmPass").value;
  const err = document.getElementById("resetErr");
  const ok = document.getElementById("resetSuccess");
  err.classList.add("d-none");
  ok.classList.add("d-none");

  if (!token || !tokenStore[token]) {
    err.textContent = "Token inválido o inexistente.";
    err.classList.remove("d-none");
    return;
  }

  const created = tokenStore[token].createdAt;
  if ((Date.now() - created) > (24 * 60 * 60 * 1000)) {
    mostrarPaso("step-expired");
    return;
  }

  if (!pass || pass.length < 8) {
    err.textContent = "La contraseña debe tener al menos 8 caracteres.";
    err.classList.remove("d-none");
    return;
  }
  if (pass !== confirm) {
    err.textContent = "Las contraseñas no coinciden.";
    err.classList.remove("d-none");
    return;
  }

  const email = tokenStore[token].email;
  userStore[email] = pass;

  delete tokenStore[token];

  ok.textContent = "Contraseña actualizada correctamente.";
  ok.classList.remove("d-none");

  setTimeout(() => {
    mostrarPaso("step-done");
    setTimeout(() => {
      window.location.href = 'B01Final.html';
    }, 900);
  }, 400);
}

function volverARequest() {
  mostrarPaso("step-request");
  document.getElementById("reqMsg").classList.add("d-none");
  document.getElementById("reqErr").classList.add("d-none");
}

function irALogin() {
  window.location.href = 'B01Final.html';
}

mostrarPaso("step-request");
</script>
</body>
</html>