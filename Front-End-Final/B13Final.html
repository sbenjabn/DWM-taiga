<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Stock - Big Bite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .muted-small { font-size:0.9rem; color:#6c757d; }
    .stock-row { padding:10px 0; border-bottom:1px solid #e9ecef; display:flex; gap:12px; align-items:center; }
    .qty { font-weight:700; }
    .small-btn { font-size:0.85rem; padding:4px 8px; }
    .ts { color:#6c757d; font-size:0.85rem; }
  </style>
</head>
<body class="bg-light">
<div class="container mt-4">
  <div class="d-flex align-items-center mb-3 gap-3">
    <h5 class="mb-0 me-auto">Inventario de insumos</h5>
    <input id="buscarInsumo" class="form-control form-control-sm" style="min-width:300px" placeholder="Buscar insumo..." oninput="renderLista()" />
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalNuevo">+ Nuevo insumo</button>
  </div>

  <div class="card mb-3">
    <div class="card-body" id="listaInsumos">
      <!-- rows -->
    </div>
  </div>

  <div class="d-flex gap-2 mb-4">
    <button class="btn btn-outline-success btn-sm" onclick="abrirIngresoMasivo()">Registrar ingreso manual</button>
    <button class="btn btn-outline-danger btn-sm" onclick="aplicarPedido789()">Procesar Pedido 789 (2 Hamburguesas queso)</button>
    <div class="muted-small align-self-center">Pedido 789 usa receta predefinida en el sistema</div>
  </div>

  <div id="msgArea"></div>
</div>

<!-- Modal: Nuevo insumo -->
<div class="modal fade" id="modalNuevo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nuevo insumo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="nuevoError" class="text-danger d-none mb-2"></div>
        <label class="form-label">Nombre del insumo</label>
        <input id="nuevoNombre" class="form-control mb-2" placeholder="Ej: Pan brioche" />
        <label class="form-label">Cantidad inicial (unidades)</label>
        <input id="nuevoCantidad" type="number" min="0" step="1" class="form-control mb-2" placeholder="Ej: 50" />
        <label class="form-label">Unidad</label>
        <input id="nuevoUnidad" class="form-control mb-2" placeholder="Ej: unidades, kg, litros" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="crearInsumo()">Crear</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Registrar ingreso / consumo -->
<div class="modal fade" id="modalMovimiento" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h6 id="movTitle" class="modal-title">Movimiento</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="movError" class="text-danger d-none mb-2"></div>
        <div class="mb-2"><strong id="movInsumoName"></strong></div>
        <label class="form-label">Cantidad</label>
        <input id="movCantidad" type="number" min="0" step="1" class="form-control mb-2" />
        <label class="form-label">Tipo</label>
        <select id="movTipo" class="form-select mb-2">
          <option value="ingreso">Ingreso</option>
          <option value="consumo">Consumo</option>
        </select>
        <label class="form-label">Fecha</label>
        <input id="movFecha" type="datetime-local" class="form-control mb-2" />
        <label class="form-label">Comentario (opcional)</label>
        <input id="movComentario" class="form-control mb-2" placeholder="Ej: Entrega proveedor X / Pedido 789" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarMovimiento()">Registrar</button>
      </div>
    </div>
  </div>
</div>

<script>

const STOCK_KEY = "bb_stock_v1";

const RECIPES = {
  "Hamburguesa queso": [
    { insumo: "Pan brioche", cantidad: 1 },
    { insumo: "Carne Angus", cantidad: 1 }
  ]
};

function loadStock() {
  try { return JSON.parse(localStorage.getItem(STOCK_KEY) || "[]"); }
  catch { return []; }
}
function saveStock(arr) { localStorage.setItem(STOCK_KEY, JSON.stringify(arr)); }

function uid(prefix='i') { return prefix + '-' + Math.random().toString(36).slice(2,9); }
function nowISOLocal(dt = new Date()) {
  const d = new Date(dt);
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().slice(0,16);
}
function formatTs(ts) { if (!ts) return '-'; return new Date(ts).toLocaleString(); }

function seedIfNeeded() {
  const existing = loadStock();
  if (existing.length === 0) {
    const now = Date.now();
    const seed = [
      { id: uid('s'), nombre: "Pan brioche", cantidad: 50, unidad: "unidades", modifiedAt: now, history: [{ tipo:'ingreso', cantidad:50, fecha: now, comentario: 'Seed inicial' }] },
      { id: uid('s'), nombre: "Carne Angus", cantidad: 20, unidad: "unidades", modifiedAt: now, history: [{ tipo:'ingreso', cantidad:20, fecha: now, comentario: 'Seed inicial' }] }
    ];
    saveStock(seed);
  }
}

function renderLista() {
  const q = (document.getElementById("buscarInsumo").value || "").trim().toLowerCase();
  const cont = document.getElementById("listaInsumos");
  const list = loadStock().filter(i => !q || i.nombre.toLowerCase().includes(q));
  cont.innerHTML = "";
  if (list.length === 0) {
    cont.innerHTML = `<div class="muted-small">No hay insumos registrados.</div>`;
    return;
  }
  list.forEach(item => {
    const row = document.createElement('div');
    row.className = 'stock-row';
    row.innerHTML = `
      <div style="flex:1">
        <div class="fw-semibold">${escapeHtml(item.nombre)}</div>
        <div class="ts">Última modificación: ${formatTs(item.modifiedAt)}</div>
      </div>
      <div style="min-width:180px;text-align:right">
        <div class="qty">${Number(item.cantidad).toLocaleString()} ${escapeHtml(item.unidad || '')}</div>
        <div class="d-flex justify-content-end gap-2 mt-2">
          <button class="btn btn-sm btn-outline-success small-btn" onclick="abrirMovimiento('${item.id}','ingreso')">Ingreso</button>
          <button class="btn btn-sm btn-outline-danger small-btn" onclick="abrirMovimiento('${item.id}','consumo')">Consumo</button>
          <button class="btn btn-sm btn-outline-secondary small-btn" onclick="verHistorial('${item.id}')">Historial</button>
        </div>
      </div>
    `;
    cont.appendChild(row);
  });
}

function crearInsumo() {
  const nombre = (document.getElementById("nuevoNombre").value || "").trim();
  const cantidadRaw = document.getElementById("nuevoCantidad").value;
  const cantidad = cantidadRaw === "" ? 0 : Number(cantidadRaw);
  const unidad = (document.getElementById("nuevoUnidad").value || "").trim() || "unidades";
  const err = document.getElementById("nuevoError");
  err.classList.add('d-none');

  if (!nombre) { err.textContent = "Nombre obligatorio"; err.classList.remove('d-none'); return; }
  if (isNaN(cantidad) || cantidad < 0) { err.textContent = "Cantidad inválida"; err.classList.remove('d-none'); return; }

  const stock = loadStock();
  if (stock.find(s => s.nombre.toLowerCase() === nombre.toLowerCase())) {
    err.textContent = "Insumo ya existente"; err.classList.remove('d-none'); return;
  }
  const now = Date.now();
  stock.push({ id: uid('s'), nombre, cantidad, unidad, modifiedAt: now, history: [{ tipo:'ingreso', cantidad, fecha: now, comentario: 'Creación' }] });
  saveStock(stock);
  bootstrap.Modal.getInstance(document.getElementById('modalNuevo')).hide();
  showMessage("Insumo creado", "success");
  renderLista();
}

let _movTargetId = null;
function abrirMovimiento(insumoId, tipo='ingreso') {
  _movTargetId = insumoId;
  const stock = loadStock();
  const item = stock.find(s => s.id === insumoId);
  if (!item) return alert("Insumo no encontrado");
  document.getElementById('movInsumoName').textContent = item.nombre;
  document.getElementById('movCantidad').value = tipo === 'ingreso' ? 1 : 1;
  document.getElementById('movTipo').value = tipo;
  document.getElementById('movFecha').value = nowISOLocal();
  document.getElementById('movComentario').value = tipo === 'ingreso' ? 'Ingreso manual' : '';
  document.getElementById('movError').classList.add('d-none');
  const modal = new bootstrap.Modal(document.getElementById('modalMovimiento'));
  modal.show();
}

function confirmarMovimiento() {
  const cantRaw = document.getElementById('movCantidad').value;
  const cantidad = cantRaw === "" ? null : Number(cantRaw);
  const tipo = document.getElementById('movTipo').value;
  const fechaStr = document.getElementById('movFecha').value;
  const comentario = (document.getElementById('movComentario').value || "").trim();
  const err = document.getElementById('movError');
  err.classList.add('d-none');

  if (_movTargetId === null) { err.textContent = "Sin insumo seleccionado"; err.classList.remove('d-none'); return; }
  if (cantidad === null || isNaN(cantidad) || cantidad <= 0) { err.textContent = "Cantidad inválida"; err.classList.remove('d-none'); return; }

  const stock = loadStock();
  const idx = stock.findIndex(s => s.id === _movTargetId);
  if (idx === -1) { err.textContent = "Insumo no encontrado"; err.classList.remove('d-none'); return; }

  const ts = fechaStr ? new Date(fechaStr).getTime() : Date.now();
  if (tipo === 'ingreso') {
    stock[idx].cantidad = Number(stock[idx].cantidad) + cantidad;
    stock[idx].history.push({ tipo:'ingreso', cantidad, fecha: ts, comentario });
  } else {
    stock[idx].cantidad = Number(stock[idx].cantidad) - cantidad;
    if (stock[idx].cantidad < 0) stock[idx].cantidad = 0;
    stock[idx].history.push({ tipo:'consumo', cantidad, fecha: ts, comentario });
  }
  stock[idx].modifiedAt = ts;
  saveStock(stock);
  bootstrap.Modal.getInstance(document.getElementById('modalMovimiento')).hide();
  showMessage("Movimiento registrado", "success");
  renderLista();
}

function verHistorial(insumoId) {
  const stock = loadStock();
  const item = stock.find(s => s.id === insumoId);
  if (!item) return alert("No encontrado");
  const lines = item.history.slice().reverse().map(h => `${h.tipo.toUpperCase()} · ${h.cantidad} · ${formatTs(h.fecha)} · ${h.comentario || ''}`);
  const txt = `Historial ${item.nombre}\n\n` + (lines.length ? lines.join('\n') : 'Sin movimientos');
  alert(txt);
}

function abrirIngresoMasivo() {
  const stock = loadStock();
  if (stock.length === 0) return alert("No hay insumos. Crea uno primero.");
  const names = stock.map(s => s.nombre).join('\n');
  const sel = prompt("Ingrese nombre del insumo a registrar (copie exactamente):\n\n" + names);
  if (!sel) return;
  const found = stock.find(s => s.nombre.toLowerCase() === sel.trim().toLowerCase());
  if (!found) return alert("Insumo no encontrado");
  abrirMovimiento(found.id, 'ingreso');
}

function aplicarPedido789() {
  const product = "Hamburguesa queso";
  const qty = 2;
  const recipe = RECIPES[product];
  if (!recipe) { return showMessage("Receta no definida para " + product, "danger"); }

  const stock = loadStock();
  const missing = [];
  recipe.forEach(r => {
    const ins = stock.find(s => s.nombre.toLowerCase() === r.insumo.toLowerCase());
    const required = r.cantidad * qty;
    if (!ins || ins.cantidad < required) missing.push({ insumo: r.insumo, required, available: ins ? ins.cantidad : 0 });
  });
  if (missing.length) {
    const lines = missing.map(m => `${m.insumo}: requiere ${m.required}, disponible ${m.available}`).join('\n');
    return alert("Stock insuficiente:\n" + lines);
  }

  recipe.forEach(r => {
    const idx = stock.findIndex(s => s.nombre.toLowerCase() === r.insumo.toLowerCase());
    const required = r.cantidad * qty;
    if (idx !== -1) {
      stock[idx].cantidad = Number(stock[idx].cantidad) - required;
      if (stock[idx].cantidad < 0) stock[idx].cantidad = 0;
      stock[idx].history.push({ tipo: 'consumo', cantidad: required, fecha: Date.now(), comentario: 'Pedido 789' });
      stock[idx].modifiedAt = Date.now();
    }
  });
  saveStock(stock);
  showMessage("Pedido 789 procesado: stock actualizado", "success");
  renderLista();
}

let _msgTimer = null;
function showMessage(text, type='info') {
  clearTimeout(_msgTimer);
  const area = document.getElementById('msgArea');
  area.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
  _msgTimer = setTimeout(()=> area.innerHTML = "", 4000);
}

function escapeHtml(s) { return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

(function init(){
  seedIfNeeded();
  renderLista();
})();
</script>
</body>
</html>